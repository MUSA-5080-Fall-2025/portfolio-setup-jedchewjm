{"title":"Assignment 2: Spatial Analysis and Visualization","markdown":{"yaml":{"title":"Assignment 2: Spatial Analysis and Visualization","subtitle":"Healthcare Access and Equity in Pennsylvania","author":"Jed Chew","date":"today","format":{"html":{"code-fold":false,"toc":true,"toc-location":"left","theme":"cosmo","embed-resources":true}},"execute":{"warning":false,"message":false},"editor":{"markdown":{"wrap":80}}},"headingText":"Assignment Overview","containsRefs":false,"markdown":"\n\n\n**Learning Objectives:**\n\n-   Apply spatial operations to answer policy-relevant research questions\n\n-   Integrate census demographic data with spatial analysis\n\n-   Create publication-quality visualizations and maps\n\n-   Work with spatial data from multiple sources\n\n-   Communicate findings effectively for policy audiences\n\n--------------------------------------------------------------------------------\n\n## Part 1: Healthcare Access for Vulnerable Populations\n\n### Research Question\n\n**Which Pennsylvania counties have the highest proportion of vulnerable\npopulations (elderly + low-income) living far from hospitals?**\n\nYour analysis should identify counties that should be priorities for healthcare\ninvestment and policy intervention.\n\n### Required Analysis Steps\n\nComplete the following analysis, documenting each step with code and brief\nexplanations:\n\n#### Step 1: Data Collection (5 points)\n\nLoad the required spatial data:\n\n-   Pennsylvania county boundaries (from lecture data)\n\n-   Pennsylvania hospitals (from lecture data)\n\n-   Pennsylvania census tracts\n\n**Your Task:**\n\n```{r}\n# Load required packages\nlibrary(tidyverse)\nlibrary(tidycensus)\nlibrary(sf)\nlibrary(tigris)\nlibrary(scales)\nlibrary(patchwork)\nlibrary(RColorBrewer)\nlibrary(units)\nlibrary(knitr)\n\n# Set Census API key\ncensus_api_key(\"fe841b7ef0aa73d9579f0517bd1c8f26d33c789b\")\n\n# Get working directory\ngetwd()\n\n# Load spatial data\npa_counties <- st_read(\"data/Pennsylvania_County_Boundaries.shp\")\ndistricts <- st_read(\"data/districts.geojson\")\nhospitals <- st_read(\"data/hospitals.geojson\")\ncensus_tracts <- tracts(state = \"PA\", cb = TRUE)\nmetro_areas <- core_based_statistical_areas(cb = TRUE)\n\n# Standardize CRS\nhospitals <- st_transform(hospitals, st_crs(pa_counties))\ncensus_tracts <- st_transform(census_tracts, st_crs(pa_counties))\nmetro_areas <- st_transform(metro_areas, st_crs(pa_counties))\ndistricts <- st_transform(districts, st_crs(census_tracts))\n\n# Check that all data loaded correctly\nggplot(pa_counties) +\n  geom_sf() +\n  labs(title = \"PA Counties\") +\n  theme_void()\n\nggplot(census_tracts) +\n  geom_sf() +\n  labs(title = \"PA Census Tracts\") +\n  theme_void()\n\nggplot(districts) +\n  geom_sf() +\n  labs(title = \"PA districts\") +\n  theme_void()\n\nggplot(hospitals) +\n  geom_sf() +\n  labs(title = \"Hospitals\") +\n  theme_minimal()\n```\n\n**Questions to answer:**\n\n-   How many hospitals are in your dataset? – **223 hospitals**\n\n```{r}\nprint(hospitals) \n```\n\n-   How many census tracts? – **3445 census tracts**\n\n```{r}\nprint(census_tracts)\n```\n\n-   What coordinate reference system is each dataset in? – **all datasets have\n    been projected to WGS 84 / Psuedo-Mercator**\n\n--------------------------------------------------------------------------------\n\n#### Step 2: Get Demographic Data\n\nUse `tidycensus` to download tract-level demographic data for Pennsylvania.\n\n**Required variables:** - Total population - Median household income -\nPopulation 65 years and over (you may need to sum multiple age categories)\n\n**Your Task:**\n\n```{r, eval = FALSE}\n# Load all available variables for ACS 5-year 2022\nacs_vars_2022 <- load_variables(2022, \"acs5\", cache = TRUE)\n```\n\n```{r}\n# Helper Variable for Summing Population Values for Elderly Population\nelderly_pop = c(\"B01001_020\", \"B01001_021\", \"B01001_022\", \"B01001_023\", \n                \"B01001_024\", \"B01001_025\", \n                \"B01001_044\", \"B01001_045\", \"B01001_046\", \n                \"B01001_047\", \"B01001_048\", \"B01001_049\")\n\n# Get tract-level demographic data from ACS\npa_data <- get_acs(\n  geography = \"tract\",\n  variables = c(\n    total_pop = \"B01003_001\",\n    median_income = \"B19013_001\",\n    elderly_pop = elderly_pop\n  ),\n  state = \"PA\",\n  year = 2022,\n  survey = \"acs5\",\n  output = \"wide\" \n)\n\n# Clean the county names to remove state name and \"County\" \npa_clean <- pa_data |> \n  separate(\n    NAME, \n    into = c(\"tract_name\", \"county_name\", \"state_name\"), \n    sep = \"; \"\n  ) |> \n  mutate(\n    tract_name = str_remove(tract_name, \"Census Tract \"),\n    county_name = str_remove(county_name, \" County\")\n  )\nhead(pa_clean)\n```\n\n```{r}\n# Sum elderly population\npa_summary <- pa_clean |>\n  mutate(\n    elderly_popE = rowSums(across(matches(\"^elderly_pop\\\\d+E$\")), na.rm = TRUE),\n    # for MOE, ACS guidance is to combine by quadrature\n    elderly_popM = sqrt(rowSums(across(matches(\"^elderly_pop\\\\d+M$\"))^2, na.rm = \n                                  TRUE)),\n    pct_elderly = elderly_popE / total_popE\n  ) |>\n  select(GEOID, tract_name, county_name, total_popE, median_incomeE, elderly_popE, \n         elderly_popM, pct_elderly)\nhead(pa_summary)\n```\n\n```{r}\n# Join to tract boundaries\ntracts_with_data <- census_tracts |> \n  left_join(pa_summary, by = \"GEOID\")\n\n# Map to confirm\nggplot(tracts_with_data) + \n  geom_sf(aes(fill = median_incomeE), linewidth = 0) +\n  scale_fill_continuous(labels = label_dollar()) + \n  labs(fill = \"Median Income\") + \n  theme_void()\n```\n\n**Questions to answer:**\n\n-   What year of ACS data are you using? – **2022 5-Year Estimates**\n\n-   How many tracts have missing income data? – **63**\n\n-   What is the median income across all PA census tracts? – **\\$70,188**\n\n```{r}\npa_tract_income_qns <- pa_summary |>\n  summarize(\n    tracts_missing_income = sum(is.na(median_incomeE)),\n    tracts_median_income = median(median_incomeE, na.rm = TRUE),\n    tract_median_elderly = mean(pct_elderly, na.rm = TRUE)\n  )\npa_tract_income_qns\n```\n\n--------------------------------------------------------------------------------\n\n#### Step 3: Define Vulnerable Populations\n\nIdentify census tracts with vulnerable populations based on TWO criteria:\n\n1.  Low median household income (choose an appropriate threshold) – **\\$70,000**\n2.  Significant elderly population (choose an appropriate threshold) – **25%**;\n\n**Your Task:**\n\n```{r}\n# Filter for vulnerable tracts based on your criteria\npa_vulnerable <- pa_summary |> \n  filter(median_incomeE <= 70000 & pct_elderly >= 0.25)\npa_vulnerable\n```\n\n**Questions to answer:**\n\n-   What income threshold did you choose and why? - **\\$70,000. This threshold\n    is slightly below median income across all PA census tracts of \\$70,188**\n\n-   What elderly population threshold did you choose and why? - **25%. This\n    threshold is slightly higher than the mean percentage elderly population\n    across all PA census tracts of 19.0%**\n\n-   How many tracts meet your vulnerability criteria? - **293 tracts**\n\n-   What percentage of PA census tracts are considered vulnerable by your\n    definition? = **8.5% are considered vulnerable**\n\n```{r}\n# Percentage of PA census tracts considered vulnerable\n293 / 3445\n```\n\n--------------------------------------------------------------------------------\n\n#### Step 4: Calculate Distance to Hospitals\n\nFor each vulnerable tract, calculate the distance to the nearest hospital.\n\n**Your Task:**\n\n```{r}\n# Update Median Income Map from Step 2\nvulnerable_tracts <- tracts_with_data |>\n  filter(median_incomeE <= 70000, pct_elderly >= 0.25)   \n\n# Project to Accurate Projected CRS of NAD 83 / Pennsylvania South State Plane\npa_crs <- 32129\nvul_proj <- st_transform(vulnerable_tracts, pa_crs)\nhosp_proj   <- st_transform(hospitals, pa_crs)\n\n# Map to confirm\nggplot(vul_proj) + \n  geom_sf(aes(fill = median_incomeE), linewidth = 0) +\n  scale_fill_continuous(labels = label_dollar()) + \n  labs(fill = \"Median Income\") + \n  theme_void()\n\nggplot(hosp_proj) + \n  geom_sf() + \n  theme_void()\n```\n\n```{r}\n# Calculate distance from each centroid to nearest hospital, then convert to miles\ncentroids <- st_centroid(vul_proj, of_largest_polygon = TRUE)              \nnn_idx    <- st_nearest_feature(centroids, hosp_proj)         \ndist_m    <- st_distance(centroids, hosp_proj[nn_idx, ], by_element = TRUE)\n\nvul_proj$dist_nearest_hosp_mi <- set_units(dist_m, \"mi\") |> drop_units()\n\nvul_proj |>\n  st_drop_geometry() |>\n  select(GEOID, tract_name, county_name, dist_nearest_hosp_mi) |>\n  arrange(desc(dist_nearest_hosp_mi)) |>\n  head(10)\n```\n\n**Requirements:**\n\n-   Use an appropriate projected coordinate system for Pennsylvania\n\n-   Calculate distances in miles\n\n-   Explain why you chose your projection\n\n**Questions to answer:**\n\n-   What is the average distance to the nearest hospital for vulnerable tracts?\n    – **5.70 miles**\n\n-   What is the maximum distance? – **29.1 miles**\n\n```{r}\npa_vul_tract_qns <- vul_proj |>\n  st_drop_geometry() |>\n  summarize(\n    average_distance = mean(dist_nearest_hosp_mi, na.rm = TRUE),\n    max_distance = max(dist_nearest_hosp_mi),\n  )\npa_vul_tract_qns\n```\n\n-   How many vulnerable tracts are more than 15 miles from the nearest hospital?\n    – **17 vulnerable tracts**\n\n```{r}\npa_num_vul_qns <- vul_proj |>\n  st_drop_geometry() |>\n  filter(dist_nearest_hosp_mi > 15)\npa_num_vul_qns\n```\n\n--------------------------------------------------------------------------------\n\n#### Step 5: Identify Underserved Areas\n\nDefine \"underserved\" as vulnerable tracts that are more than 15 miles from the\nnearest hospital.\n\n**Questions to answer:**\n\n-   How many tracts are underserved? – **17 tracts (same as last question of\n    Step 4)**\n\n-   What percentage of vulnerable tracts are underserved? – **5.8% of vulnerable\n    tracts are underserved**\n\n```{r}\n17 / 293\n```\n\n-   Does this surprise you? Why or why not? – **This low percentage does not\n    surprise me, given that Pennsylvania is home to the hospital system of Penn\n    Medicine and the Children's Hospital of Philadelphia (CHOP).**\n\n--------------------------------------------------------------------------------\n\n#### Step 6: Aggregate to County Level\n\nUse spatial joins and aggregation to calculate county-level statistics about\nvulnerable populations and hospital access.\n\n**Your Task:**\n\n```{r}\n# Normalize the county layer (create county_geoid + county_name)\npa_counties_norm <- pa_counties |> \n  mutate(\n    county_geoid = paste0(\"42\", str_pad(as.character(FIPS_COUNT), 3, pad = \"0\")),\n    county_name  = COUNTY_NAM\n  ) |> \n  st_transform(32129) |>                     # PA South State Plane (meters)\n  select(county_geoid, county_name, geometry)\n\n# Define underserved threshold\nunderserved_threshold_mi <- 15\n\n# Spatial join tracts → counties and aggregate\ncounty_summary <- pa_counties_norm |> \n  st_join(\n    vul_proj |> \n      mutate(underserved = dist_nearest_hosp_mi > underserved_threshold_mi) |> \n      select(tr_geoid = GEOID,\n             dist_nearest_hosp_mi,\n             total_popE,\n             elderly_popE,\n             underserved),\n    join = st_intersects,\n    left = TRUE                                  # keep all 67 counties\n  ) %>%\n  st_drop_geometry() |> \n  group_by(county_geoid, county_name) |> \n  summarise(\n    n_vulnerable_tracts        = sum(!is.na(tr_geoid)),\n    n_underserved_tracts       = sum(underserved %in% TRUE, na.rm = TRUE),\n    pct_vuln_underserved       = 100 * n_underserved_tracts / n_vulnerable_tracts,\n    avg_dist_nearest_hosp_mi   = mean(dist_nearest_hosp_mi, na.rm = TRUE),\n    total_vulnerable_residents = sum(replace_na(total_popE, 0), na.rm = TRUE),\n  ) |> \nungroup() |> \narrange(desc(pct_vuln_underserved))\n\ncounty_summary\n```\n\n**Required county-level statistics:** - Number of vulnerable tracts - Number of\nunderserved tracts\\\n- Percentage of vulnerable tracts that are underserved - Average distance to\nnearest hospital for vulnerable tracts - Total vulnerable population\n\n**Questions to answer:**\n\n-   Which 5 counties have the highest percentage of underserved vulnerable\n    tracts? – **Dauphin, Perry, Bradford, Clinton, Sullivan**\n\n```{r}\nslice(county_summary, 1:5)\n```\n\n-   Which counties have the most vulnerable people living far from hospitals?\n    **– Pike, Bradford, Forest, Sullivan, Perry, Fulton, and Dauphin**\n\n```{r}\ncounty_summary |> \n  filter(avg_dist_nearest_hosp_mi > 15) |> \n  arrange(desc(total_vulnerable_residents))\n```\n\n-   Are there any patterns in where underserved counties are located?\n\n--------------------------------------------------------------------------------\n\n#### Step 7: Create Summary Table\n\nCreate a professional table showing the top 10 priority counties for healthcare\ninvestment.\n\n**Your Task:**\n\n```{r}\npriority_counties <- county_summary |> \n  arrange(desc(avg_dist_nearest_hosp_mi), desc(total_vulnerable_residents)) |> \n  select(county_name, total_vulnerable_residents, n_vulnerable_tracts, \n         n_underserved_tracts, avg_dist_nearest_hosp_mi) |> \n  slice(1:10)\n\nkable(priority_counties,\n      col.names = c(\"County\", \"Vulnerable Residents\", \"Vulnerable Tracts\", \n                    \"Underserved Tracts\", \"Avg Distance to Nearest Hospital\"),\n      caption = \"Top 10 Priority Counties in PA for Healthcare Investment\",\n      format.args = list(big.mark = \",\"))\n```\n\n**Requirements:**\n\n-   Use `knitr::kable()` or similar for formatting\n\n-   Include descriptive column names\n\n-   Format numbers appropriately (commas for population, percentages, etc.)\n\n-   Add an informative caption\n\n-   Sort by priority (you decide the metric)\n\n--------------------------------------------------------------------------------\n\n## Part 2: Comprehensive Visualization\n\nUsing the skills from Week 3 (Data Visualization), create publication-quality\nmaps and charts.\n\n### Map 1: County-Level Choropleth\n\nCreate a choropleth map showing healthcare access challenges at the county\nlevel.\n\n**Your Task:**\n\n```{r}\nlibrary(scales)\nlibrary(RColorBrewer)\n\n# Spatial Joins and Projections\ncounty_summary_sf <- pa_counties_norm %>%\n  left_join(county_summary, by = \"county_geoid\")\nhosp_pts <- hospitals %>% st_transform(st_crs(county_summary_sf))\n\n# Create county-level access map\nggplot(county_summary_sf) +\n  geom_sf(aes(fill = pct_vuln_underserved), color = \"white\", linewidth = 0.25) +\n  geom_sf(data = hosp_pts, size = 0.9, alpha = 0.8) +\n  scale_fill_distiller(\n    name = \"% of vulnerable tracts\\n> 15 miles from a hospital\",\n    palette = \"Reds\",       \n    direction = 1,          # light (low) -> dark (high)\n    na.value = \"grey90\",\n    limits = c(0, 100),\n    breaks = c(0, 25, 50, 75, 100),\n    labels = label_percent(accuracy = 1, scale = 1),\n    guide = guide_colorbar(barheight = unit(80, \"pt\"))\n  ) +\n  labs(\n    title = \"Healthcare Access Challenges by County — Pennsylvania\",\n    subtitle = \"Percentage of vulnerable tracts that are underserved (threshold = 15 miles)\",\n    caption  = \"Notes: Grey counties have no vulnerable tracts. Distances computed in PA South State Plane\"\n  ) +\n  theme_void() +\n  theme(legend.position = \"right\")\n```\n\n**Requirements:** - Fill counties by percentage of vulnerable tracts that are\nunderserved - Include hospital locations as points - Use an appropriate color\nscheme - Include clear title, subtitle, and caption - Use `theme_void()` or\nsimilar clean theme - Add a legend with formatted labels\n\n--------------------------------------------------------------------------------\n\n### Map 2: Detailed Vulnerability Map\n\nCreate a map highlighting underserved vulnerable tracts.\n\n**Your Task:**\n\n```{r}\n# Create detailed tract-level map\nunderserved_threshold_mi <- 15\nvul_status <- vul_proj |> \n  mutate(\n    status = if_else(dist_nearest_hosp_mi > underserved_threshold_mi,\n                     \"Underserved\", \"Vulnerable\")\n  )\n\n# 2) Plot\nggplot() +\n  # Base: county boundaries for context (low visual weight)\n  geom_sf(data = pa_counties_norm, fill = NA, color = \"grey60\", linewidth = 0.3) +\n\n  # Other vulnerable tracts (de-emphasized)\n  geom_sf(data = subset(vul_status, status == \"Vulnerable\"),\n          aes(fill = status), color = NA, alpha = 0.35) +\n\n  # Underserved vulnerable tracts (primary focus)\n  geom_sf(data = subset(vul_status, status == \"Underserved\"),\n          aes(fill = status), color = \"#7f0000\", linewidth = 0.2, alpha = 0.9) +\n\n  # Hospitals (symbols on top for maximum legibility)\n  geom_sf(data = hosp_pts, aes(shape = \"Hospital\"),\n          size = 1.2, color = \"black\", fill = \"white\", stroke = 0.4) +\n\n  # Manual scales to control contrast & legend\n  scale_fill_manual(\n    name   = NULL,\n    values = c(\"Underserved\" = \"#cb181d\",  # strong red\n               \"Vulnerable\"  = \"grey80\")\n  ) +\n  scale_shape_manual(\n    name   = NULL,\n    values = c(\"Hospital\" = 21)  # filled circle w/ border\n  ) +\n  guides(\n    fill  = guide_legend(order = 1, override.aes = list(alpha = c(0.9, 0.35))),\n    shape = guide_legend(order = 2, override.aes = list(size = 3))\n  ) +\n\n  labs(\n    title    = \"Underserved Census Tracts and Hospital Locations — Pennsylvania\",\n    subtitle = \"Red tracts: vulnerable and > 15 miles from the nearest hospital\",\n    caption  = \"Distances computed in EPSG:32129 (PA South State Plane)\"\n  ) +\n  theme_void(base_size = 12) +\n  theme(\n    legend.position = \"right\",\n  ) +\n  coord_sf(datum = NA)\n```\n\n**Requirements:** - Show underserved vulnerable tracts in a contrasting color -\nInclude county boundaries for context - Show hospital locations - Use\nappropriate visual hierarchy (what should stand out?) - Include informative\ntitle and subtitle\n\n--------------------------------------------------------------------------------\n\n### Chart: Distribution Analysis\n\nCreate a visualization showing the distribution of distances to hospitals for\nvulnerable populations.\n\n**Your Task:**\n\n```{r}\n# Create distribution visualization\n\nvul_regions <- vul_proj |> \n  mutate(underserved = dist_nearest_hosp_mi > underserved_threshold_mi)\n\n# Compute tract centroids in lon/lat just for region assignment\nvul_ll <- st_transform(vul_regions, 4326)\nctr    <- st_centroid(vul_ll)\nlon    <- st_coordinates(ctr)[,1]\nq      <- quantile(lon, probs = c(1/3, 2/3), na.rm = TRUE)\n\nvul_regions <- vul_regions |> \n  mutate(region3 = case_when(\n    lon <= q[1] ~ \"West\",\n    lon >  q[2] ~ \"East\",\n    TRUE        ~ \"Central\"\n  )) %>%\n  mutate(region3 = factor(region3, levels = c(\"West\",\"Central\",\"East\")))\n\n# 1) Histogram of distances (with underserved threshold)\np_hist <- ggplot(vul_regions, aes(x = dist_nearest_hosp_mi)) +\n  geom_histogram(binwidth = 2, boundary = 0, closed = \"left\",\n                 fill = \"#9ecae1\", color = \"white\") +\n  geom_vline(xintercept = underserved_threshold_mi, linetype = \"dashed\") +\n  labs(\n    title   = \"Distribution of Distances to the Nearest Hospital (Vulnerable Tracts)\",\n    x       = \"Distance to nearest hospital (miles)\",\n    y       = \"Number of tracts\",\n    caption = \"Dashed line marks the underserved threshold (15 miles). Look for right-skew and the share beyond the threshold.\"\n  ) +\n  theme_minimal(base_size = 12)\n\n# 2) Box plot by regions (West/Central/East)\np_box <- ggplot(vul_regions, aes(x = region3, y = dist_nearest_hosp_mi, fill = region3)) +\n  geom_boxplot(outlier.alpha = 0.3) +\n  geom_hline(yintercept = underserved_threshold_mi, linetype = \"dashed\") +\n  scale_fill_brewer(palette = \"Set2\", guide = \"none\") +\n  labs(\n    title    = \"Distance to Hospital by Region (Vulnerable Tracts)\",\n    subtitle = \"Regions defined by longitude terciles (West, Central, East)\",\n    x        = NULL,\n    y        = \"Distance to nearest hospital (miles)\",\n    caption  = \"Regions with higher medians indicate broader access challenges.\"\n  ) +\n  theme_minimal(base_size = 12)\n\n# 3) Bar chart: underserved tracts by county (Top 15 for readability)\nbar_df <- county_summary %>%\n  select(county_name, n_underserved_tracts) %>%\n  arrange(desc(n_underserved_tracts)) %>%\n  slice_head(n = 15)\n\np_bar <- ggplot(bar_df,\n                aes(x = reorder(county_name, n_underserved_tracts),\n                    y = n_underserved_tracts)) +\n  geom_col(fill = \"#cb181d\") +\n  coord_flip() +\n  labs(\n    title   = \"Underserved Vulnerable Tracts by County (Top 15)\",\n    x       = NULL,\n    y       = \"Underserved vulnerable tracts (count)\",\n    caption = \"Highlights where the count of tracts beyond 15 miles is most concentrated.\"\n  ) +\n  theme_minimal(base_size = 12)\n\n# 4) Scatter: distance vs. vulnerable population size (per tract)\np_scatter <- ggplot(vul_regions,\n                    aes(x = dist_nearest_hosp_mi,\n                        y = total_popE,\n                        color = underserved)) +\n  geom_point(alpha = 0.5) +\n  geom_smooth(method = \"loess\", se = FALSE,\n              linetype = \"dashed\", color = \"black\", linewidth = 0.8) +\n  scale_color_manual(\n    values = c(`TRUE` = \"#cb181d\", `FALSE` = \"grey60\"),\n    name   = \"Underserved?\",\n    labels = c(\"No (≤ 15 mi)\", \"Yes (> 15 mi)\")\n  ) +\n  scale_y_continuous(labels = comma) +\n  labs(\n    title   = \"Distance vs. Vulnerable Population Size (Tracts)\",\n    x       = \"Distance to nearest hospital (miles)\",\n    y       = \"Vulnerable population (tract total)\",\n    caption = \"Dashed curve shows the local trend\"\n  ) +\n  theme_minimal(base_size = 12)\n\n\n```\n\n```{r}\np_hist\np_box\np_bar\np_scatter\n```\n\n**Suggested chart types:** - Histogram or density plot of distances - Box plot\ncomparing distances across regions - Bar chart of underserved tracts by county -\nScatter plot of distance vs. vulnerable population size\n\n**Requirements:** - Clear axes labels with units - Appropriate title -\nProfessional formatting - Brief interpretation (1-2 sentences as a caption or in\ntext)\n\n--------------------------------------------------------------------------------\n\n## Part 3: Bring Your Own Data Analysis\n\nChoose your own additional spatial dataset and conduct a supplementary analysis.\n\n### Challenge Options\n\nChoose ONE of the following challenge exercises, or propose your own research\nquestion using OpenDataPhilly data (https://opendataphilly.org/datasets/).\n\n**Note these are just loose suggestions to spark ideas - follow or make your own\nas the data permits and as your ideas evolve. This analysis should include\nbringing in your own dataset, ensuring the projection/CRS of your layers align\nand are appropriate for the analysis (not lat/long or geodetic coordinate\nsystems). The analysis portion should include some combination of spatial and\nattribute operations to answer a relatively straightforward question**\n\n--------------------------------------------------------------------------------\n\n#### Education & Youth Services\n\n**Option A: Educational Desert Analysis**\n\n-   **Data:** Schools, Libraries, Recreation Centers, Census tracts (child\n    population)\n\n-   **Question:** \"Which neighborhoods lack adequate educational infrastructure\n    for children?\"\n\n-   **Operations:** Buffer schools/libraries (0.5 mile walking distance),\n    identify coverage gaps, overlay with child population density\n\n-   **Policy relevance:** School district planning, library placement,\n    after-school program siting\n\n**Option B: School Safety Zones**\n\n-   **Data:** Schools, Crime Incidents, Bike Network\n\n-   **Question:** \"Are school zones safe for walking/biking, or are they crime\n    hotspots?\"\n\n-   **Operations:** Buffer schools (1000ft safety zone), spatial join with crime\n    incidents, assess bike infrastructure coverage\n\n-   **Policy relevance:** Safe Routes to School programs, crossing guard\n    placement\n\n--------------------------------------------------------------------------------\n\n#### Environmental Justice\n\n**Option C: Green Space Equity**\n\n-   **Data:** Parks, Street Trees, Census tracts (race/income demographics)\n-   **Question:** \"Do low-income and minority neighborhoods have equitable\n    access to green space?\"\n-   **Operations:** Buffer parks (10-minute walk = 0.5 mile), calculate tree\n    canopy or park acreage per capita, compare by demographics\n-   **Policy relevance:** Climate resilience, environmental justice, urban\n    forestry investment - ---\n\n#### Public Safety & Justice\n\n**Option D: Crime & Community Resources**\n\n-   **Data:** Crime Incidents, Recreation Centers, Libraries, Street Lights\n\n-   **Question:** \"Are high-crime areas underserved by community resources?\"\n\n-   **Operations:** Aggregate crime counts to census tracts or neighborhoods,\n    count community resources per area, spatial correlation analysis\n\n-   **Policy relevance:** Community investment, violence prevention strategies\n\n#### Infrastructure & Services\n\n**Option E: Polling Place Accessibility**\n\n-   **Data:** Polling Places, SEPTA stops, Census tracts (elderly population,\n    disability rates)\n\n-   **Question:** \"Are polling places accessible for elderly and disabled\n    voters?\"\n\n-   **Operations:** Buffer polling places and transit stops, identify vulnerable\n    populations, find areas lacking access\n\n-   **Policy relevance:** Voting rights, election infrastructure, ADA compliance\n\n--------------------------------------------------------------------------------\n\n#### Health & Wellness\n\n**Option F: Recreation & Population Health**\n\n-   **Data:** Recreation Centers, Playgrounds, Parks, Census tracts\n    (demographics)\n\n-   **Question:** \"Is lack of recreation access associated with vulnerable\n    populations?\"\n\n-   **Operations:** Calculate recreation facilities per capita by neighborhood,\n    buffer facilities for walking access, overlay with demographic indicators\n\n-   **Policy relevance:** Public health investment, recreation programming,\n    obesity prevention\n\n--------------------------------------------------------------------------------\n\n#### Emergency Services\n\n**Option G: EMS Response Coverage**\n\n-   **Data:** Fire Stations, EMS stations, Population density, High-rise\n    buildings\n\n-   **Question:** \"Are population-dense areas adequately covered by emergency\n    services?\"\n\n-   **Operations:** Create service area buffers (5-minute drive = \\~2 miles),\n    assess population coverage, identify gaps in high-density areas\n\n-   **Policy relevance:** Emergency preparedness, station siting decisions\n\n--------------------------------------------------------------------------------\n\n#### Arts & Culture\n\n**Option H: Cultural Asset Distribution**\n\n-   **Data:** Public Art, Museums, Historic sites/markers, Neighborhoods\n\n-   **Question:** \"Do all neighborhoods have equitable access to cultural\n    amenities?\"\n\n-   **Operations:** Count cultural assets per neighborhood, normalize by\n    population, compare distribution across demographic groups\n\n-   **Policy relevance:** Cultural equity, tourism, quality of life,\n    neighborhood identity\n\n--------------------------------------------------------------------------------\n\n### Data Sources\n\n**OpenDataPhilly:** https://opendataphilly.org/datasets/ - Most datasets\navailable as GeoJSON, Shapefile, or CSV with coordinates - Always check the\nMetadata for a data dictionary of the fields.\n\n**Additional Sources:**\n\n-   **Pennsylvania Open Data:** https://data.pa.gov/\n\n-   **Census Bureau (via tidycensus):** Demographics, economic indicators,\n    commute patterns\n\n-   **TIGER/Line (via tigris):** Geographic boundaries\n\n### Recommended Starting Points\n\n**If you're feeling confident:** Choose an advanced challenge with multiple data\nlayers. **If you are a beginner, choose something more manageable that helps you\nunderstand the basics**\n\n**If you have a different idea:** Propose your own question! Just make sure:\n\n-   You can access the spatial data\n\n-   You can perform at least 2 spatial operations\n\n### Your Analysis\n\n**My Chosen Question: Small Businesses**\n\n-   **Question:** \"Is lack of recreation access associated with vulnerable\n    populations?\"\n\n<!-- -->\n\n-   Data Source A:\n    <https://phl.maps.arcgis.com/apps/MapSeries/index.html?appid=ab8597d96ece43be97e718f919e79194>\n\n-   Data Source B:\n    <https://opendataphilly.org/datasets/neighborhood-food-retail/>\n\n-   Data Source C: Dataaxle\n\n**Your Task:**\n\n1.  **Find and load additional data**\n    -   Document your data source\n    -   Check and standardize the CRS\n    -   Provide basic summary statistics\n\n```{r}\n# Load your additional dataset\n\n\n\n\n```\n\n**Questions to answer:**\n\n-   What dataset did you choose and why?\n\n-   What is the data source and date?\n\n-   How many features does it contain?\n\n-   What CRS is it in? Did you need to transform it?\n\n--------------------------------------------------------------------------------\n\n2.  **Pose a research question**\n\nWrite a clear research statement that your analysis will answer.\n\n**Examples:** - \"Do vulnerable tracts have adequate public transit access to\nhospitals?\" - \"Are EMS stations appropriately located near vulnerable\npopulations?\" - \"Do areas with low vehicle access have worse hospital access?\"\n\n--------------------------------------------------------------------------------\n\n3.  **Conduct spatial analysis**\n\nUse at least TWO spatial operations to answer your research question.\n\n**Required operations (choose 2+):**\n\n-   Buffers / Intersections / Unions / Distance Calculations\n\n-   Spatial joins\n\n-   Spatial filtering with predicates\n\n-   Point-in-polygon aggregation\n\n**Your Task:**\n\n```{r}\n# Your spatial analysis\n\n\n\n\n\n\n\n\n\n\n```\n\n**Analysis requirements:**\n\n-   Clear code comments explaining each step\n\n-   Appropriate CRS transformations\n\n-   Summary statistics or counts\n\n-   At least one map showing your findings\n\n-   Brief interpretation of results (3-5 sentences)\n\n**Your interpretation:**\n\n*\\[Write your findings here\\]*\n\n## Finally - A few comments about your incorporation of feedback!\n\nTake a few moments to clean up your markdown document and then write a line or\ntwo or three about how you may have incorporated feedback that you recieved\nafter your first assignment.\n\n*\\[Incorporation of Feedback\\]*\n\n--------------------------------------------------------------------------------\n\n## Submission Requirements\n\n**What to submit:**\n\n1.  **Rendered HTML document posted to your course portfolio** with all code,\n    outputs, maps, and text\n    -   Use `embed-resources: true` in YAML so it's a single file\n    -   All code should run without errors\n    -   All maps and charts should display correctly\n\n**File naming:** `LastName_FirstName_Assignment2.html` and\n`LastName_FirstName_Assignment2.qmd`\n\n--------------------------------------------------------------------------------\n","srcMarkdownNoYaml":"\n\n## Assignment Overview\n\n**Learning Objectives:**\n\n-   Apply spatial operations to answer policy-relevant research questions\n\n-   Integrate census demographic data with spatial analysis\n\n-   Create publication-quality visualizations and maps\n\n-   Work with spatial data from multiple sources\n\n-   Communicate findings effectively for policy audiences\n\n--------------------------------------------------------------------------------\n\n## Part 1: Healthcare Access for Vulnerable Populations\n\n### Research Question\n\n**Which Pennsylvania counties have the highest proportion of vulnerable\npopulations (elderly + low-income) living far from hospitals?**\n\nYour analysis should identify counties that should be priorities for healthcare\ninvestment and policy intervention.\n\n### Required Analysis Steps\n\nComplete the following analysis, documenting each step with code and brief\nexplanations:\n\n#### Step 1: Data Collection (5 points)\n\nLoad the required spatial data:\n\n-   Pennsylvania county boundaries (from lecture data)\n\n-   Pennsylvania hospitals (from lecture data)\n\n-   Pennsylvania census tracts\n\n**Your Task:**\n\n```{r}\n# Load required packages\nlibrary(tidyverse)\nlibrary(tidycensus)\nlibrary(sf)\nlibrary(tigris)\nlibrary(scales)\nlibrary(patchwork)\nlibrary(RColorBrewer)\nlibrary(units)\nlibrary(knitr)\n\n# Set Census API key\ncensus_api_key(\"fe841b7ef0aa73d9579f0517bd1c8f26d33c789b\")\n\n# Get working directory\ngetwd()\n\n# Load spatial data\npa_counties <- st_read(\"data/Pennsylvania_County_Boundaries.shp\")\ndistricts <- st_read(\"data/districts.geojson\")\nhospitals <- st_read(\"data/hospitals.geojson\")\ncensus_tracts <- tracts(state = \"PA\", cb = TRUE)\nmetro_areas <- core_based_statistical_areas(cb = TRUE)\n\n# Standardize CRS\nhospitals <- st_transform(hospitals, st_crs(pa_counties))\ncensus_tracts <- st_transform(census_tracts, st_crs(pa_counties))\nmetro_areas <- st_transform(metro_areas, st_crs(pa_counties))\ndistricts <- st_transform(districts, st_crs(census_tracts))\n\n# Check that all data loaded correctly\nggplot(pa_counties) +\n  geom_sf() +\n  labs(title = \"PA Counties\") +\n  theme_void()\n\nggplot(census_tracts) +\n  geom_sf() +\n  labs(title = \"PA Census Tracts\") +\n  theme_void()\n\nggplot(districts) +\n  geom_sf() +\n  labs(title = \"PA districts\") +\n  theme_void()\n\nggplot(hospitals) +\n  geom_sf() +\n  labs(title = \"Hospitals\") +\n  theme_minimal()\n```\n\n**Questions to answer:**\n\n-   How many hospitals are in your dataset? – **223 hospitals**\n\n```{r}\nprint(hospitals) \n```\n\n-   How many census tracts? – **3445 census tracts**\n\n```{r}\nprint(census_tracts)\n```\n\n-   What coordinate reference system is each dataset in? – **all datasets have\n    been projected to WGS 84 / Psuedo-Mercator**\n\n--------------------------------------------------------------------------------\n\n#### Step 2: Get Demographic Data\n\nUse `tidycensus` to download tract-level demographic data for Pennsylvania.\n\n**Required variables:** - Total population - Median household income -\nPopulation 65 years and over (you may need to sum multiple age categories)\n\n**Your Task:**\n\n```{r, eval = FALSE}\n# Load all available variables for ACS 5-year 2022\nacs_vars_2022 <- load_variables(2022, \"acs5\", cache = TRUE)\n```\n\n```{r}\n# Helper Variable for Summing Population Values for Elderly Population\nelderly_pop = c(\"B01001_020\", \"B01001_021\", \"B01001_022\", \"B01001_023\", \n                \"B01001_024\", \"B01001_025\", \n                \"B01001_044\", \"B01001_045\", \"B01001_046\", \n                \"B01001_047\", \"B01001_048\", \"B01001_049\")\n\n# Get tract-level demographic data from ACS\npa_data <- get_acs(\n  geography = \"tract\",\n  variables = c(\n    total_pop = \"B01003_001\",\n    median_income = \"B19013_001\",\n    elderly_pop = elderly_pop\n  ),\n  state = \"PA\",\n  year = 2022,\n  survey = \"acs5\",\n  output = \"wide\" \n)\n\n# Clean the county names to remove state name and \"County\" \npa_clean <- pa_data |> \n  separate(\n    NAME, \n    into = c(\"tract_name\", \"county_name\", \"state_name\"), \n    sep = \"; \"\n  ) |> \n  mutate(\n    tract_name = str_remove(tract_name, \"Census Tract \"),\n    county_name = str_remove(county_name, \" County\")\n  )\nhead(pa_clean)\n```\n\n```{r}\n# Sum elderly population\npa_summary <- pa_clean |>\n  mutate(\n    elderly_popE = rowSums(across(matches(\"^elderly_pop\\\\d+E$\")), na.rm = TRUE),\n    # for MOE, ACS guidance is to combine by quadrature\n    elderly_popM = sqrt(rowSums(across(matches(\"^elderly_pop\\\\d+M$\"))^2, na.rm = \n                                  TRUE)),\n    pct_elderly = elderly_popE / total_popE\n  ) |>\n  select(GEOID, tract_name, county_name, total_popE, median_incomeE, elderly_popE, \n         elderly_popM, pct_elderly)\nhead(pa_summary)\n```\n\n```{r}\n# Join to tract boundaries\ntracts_with_data <- census_tracts |> \n  left_join(pa_summary, by = \"GEOID\")\n\n# Map to confirm\nggplot(tracts_with_data) + \n  geom_sf(aes(fill = median_incomeE), linewidth = 0) +\n  scale_fill_continuous(labels = label_dollar()) + \n  labs(fill = \"Median Income\") + \n  theme_void()\n```\n\n**Questions to answer:**\n\n-   What year of ACS data are you using? – **2022 5-Year Estimates**\n\n-   How many tracts have missing income data? – **63**\n\n-   What is the median income across all PA census tracts? – **\\$70,188**\n\n```{r}\npa_tract_income_qns <- pa_summary |>\n  summarize(\n    tracts_missing_income = sum(is.na(median_incomeE)),\n    tracts_median_income = median(median_incomeE, na.rm = TRUE),\n    tract_median_elderly = mean(pct_elderly, na.rm = TRUE)\n  )\npa_tract_income_qns\n```\n\n--------------------------------------------------------------------------------\n\n#### Step 3: Define Vulnerable Populations\n\nIdentify census tracts with vulnerable populations based on TWO criteria:\n\n1.  Low median household income (choose an appropriate threshold) – **\\$70,000**\n2.  Significant elderly population (choose an appropriate threshold) – **25%**;\n\n**Your Task:**\n\n```{r}\n# Filter for vulnerable tracts based on your criteria\npa_vulnerable <- pa_summary |> \n  filter(median_incomeE <= 70000 & pct_elderly >= 0.25)\npa_vulnerable\n```\n\n**Questions to answer:**\n\n-   What income threshold did you choose and why? - **\\$70,000. This threshold\n    is slightly below median income across all PA census tracts of \\$70,188**\n\n-   What elderly population threshold did you choose and why? - **25%. This\n    threshold is slightly higher than the mean percentage elderly population\n    across all PA census tracts of 19.0%**\n\n-   How many tracts meet your vulnerability criteria? - **293 tracts**\n\n-   What percentage of PA census tracts are considered vulnerable by your\n    definition? = **8.5% are considered vulnerable**\n\n```{r}\n# Percentage of PA census tracts considered vulnerable\n293 / 3445\n```\n\n--------------------------------------------------------------------------------\n\n#### Step 4: Calculate Distance to Hospitals\n\nFor each vulnerable tract, calculate the distance to the nearest hospital.\n\n**Your Task:**\n\n```{r}\n# Update Median Income Map from Step 2\nvulnerable_tracts <- tracts_with_data |>\n  filter(median_incomeE <= 70000, pct_elderly >= 0.25)   \n\n# Project to Accurate Projected CRS of NAD 83 / Pennsylvania South State Plane\npa_crs <- 32129\nvul_proj <- st_transform(vulnerable_tracts, pa_crs)\nhosp_proj   <- st_transform(hospitals, pa_crs)\n\n# Map to confirm\nggplot(vul_proj) + \n  geom_sf(aes(fill = median_incomeE), linewidth = 0) +\n  scale_fill_continuous(labels = label_dollar()) + \n  labs(fill = \"Median Income\") + \n  theme_void()\n\nggplot(hosp_proj) + \n  geom_sf() + \n  theme_void()\n```\n\n```{r}\n# Calculate distance from each centroid to nearest hospital, then convert to miles\ncentroids <- st_centroid(vul_proj, of_largest_polygon = TRUE)              \nnn_idx    <- st_nearest_feature(centroids, hosp_proj)         \ndist_m    <- st_distance(centroids, hosp_proj[nn_idx, ], by_element = TRUE)\n\nvul_proj$dist_nearest_hosp_mi <- set_units(dist_m, \"mi\") |> drop_units()\n\nvul_proj |>\n  st_drop_geometry() |>\n  select(GEOID, tract_name, county_name, dist_nearest_hosp_mi) |>\n  arrange(desc(dist_nearest_hosp_mi)) |>\n  head(10)\n```\n\n**Requirements:**\n\n-   Use an appropriate projected coordinate system for Pennsylvania\n\n-   Calculate distances in miles\n\n-   Explain why you chose your projection\n\n**Questions to answer:**\n\n-   What is the average distance to the nearest hospital for vulnerable tracts?\n    – **5.70 miles**\n\n-   What is the maximum distance? – **29.1 miles**\n\n```{r}\npa_vul_tract_qns <- vul_proj |>\n  st_drop_geometry() |>\n  summarize(\n    average_distance = mean(dist_nearest_hosp_mi, na.rm = TRUE),\n    max_distance = max(dist_nearest_hosp_mi),\n  )\npa_vul_tract_qns\n```\n\n-   How many vulnerable tracts are more than 15 miles from the nearest hospital?\n    – **17 vulnerable tracts**\n\n```{r}\npa_num_vul_qns <- vul_proj |>\n  st_drop_geometry() |>\n  filter(dist_nearest_hosp_mi > 15)\npa_num_vul_qns\n```\n\n--------------------------------------------------------------------------------\n\n#### Step 5: Identify Underserved Areas\n\nDefine \"underserved\" as vulnerable tracts that are more than 15 miles from the\nnearest hospital.\n\n**Questions to answer:**\n\n-   How many tracts are underserved? – **17 tracts (same as last question of\n    Step 4)**\n\n-   What percentage of vulnerable tracts are underserved? – **5.8% of vulnerable\n    tracts are underserved**\n\n```{r}\n17 / 293\n```\n\n-   Does this surprise you? Why or why not? – **This low percentage does not\n    surprise me, given that Pennsylvania is home to the hospital system of Penn\n    Medicine and the Children's Hospital of Philadelphia (CHOP).**\n\n--------------------------------------------------------------------------------\n\n#### Step 6: Aggregate to County Level\n\nUse spatial joins and aggregation to calculate county-level statistics about\nvulnerable populations and hospital access.\n\n**Your Task:**\n\n```{r}\n# Normalize the county layer (create county_geoid + county_name)\npa_counties_norm <- pa_counties |> \n  mutate(\n    county_geoid = paste0(\"42\", str_pad(as.character(FIPS_COUNT), 3, pad = \"0\")),\n    county_name  = COUNTY_NAM\n  ) |> \n  st_transform(32129) |>                     # PA South State Plane (meters)\n  select(county_geoid, county_name, geometry)\n\n# Define underserved threshold\nunderserved_threshold_mi <- 15\n\n# Spatial join tracts → counties and aggregate\ncounty_summary <- pa_counties_norm |> \n  st_join(\n    vul_proj |> \n      mutate(underserved = dist_nearest_hosp_mi > underserved_threshold_mi) |> \n      select(tr_geoid = GEOID,\n             dist_nearest_hosp_mi,\n             total_popE,\n             elderly_popE,\n             underserved),\n    join = st_intersects,\n    left = TRUE                                  # keep all 67 counties\n  ) %>%\n  st_drop_geometry() |> \n  group_by(county_geoid, county_name) |> \n  summarise(\n    n_vulnerable_tracts        = sum(!is.na(tr_geoid)),\n    n_underserved_tracts       = sum(underserved %in% TRUE, na.rm = TRUE),\n    pct_vuln_underserved       = 100 * n_underserved_tracts / n_vulnerable_tracts,\n    avg_dist_nearest_hosp_mi   = mean(dist_nearest_hosp_mi, na.rm = TRUE),\n    total_vulnerable_residents = sum(replace_na(total_popE, 0), na.rm = TRUE),\n  ) |> \nungroup() |> \narrange(desc(pct_vuln_underserved))\n\ncounty_summary\n```\n\n**Required county-level statistics:** - Number of vulnerable tracts - Number of\nunderserved tracts\\\n- Percentage of vulnerable tracts that are underserved - Average distance to\nnearest hospital for vulnerable tracts - Total vulnerable population\n\n**Questions to answer:**\n\n-   Which 5 counties have the highest percentage of underserved vulnerable\n    tracts? – **Dauphin, Perry, Bradford, Clinton, Sullivan**\n\n```{r}\nslice(county_summary, 1:5)\n```\n\n-   Which counties have the most vulnerable people living far from hospitals?\n    **– Pike, Bradford, Forest, Sullivan, Perry, Fulton, and Dauphin**\n\n```{r}\ncounty_summary |> \n  filter(avg_dist_nearest_hosp_mi > 15) |> \n  arrange(desc(total_vulnerable_residents))\n```\n\n-   Are there any patterns in where underserved counties are located?\n\n--------------------------------------------------------------------------------\n\n#### Step 7: Create Summary Table\n\nCreate a professional table showing the top 10 priority counties for healthcare\ninvestment.\n\n**Your Task:**\n\n```{r}\npriority_counties <- county_summary |> \n  arrange(desc(avg_dist_nearest_hosp_mi), desc(total_vulnerable_residents)) |> \n  select(county_name, total_vulnerable_residents, n_vulnerable_tracts, \n         n_underserved_tracts, avg_dist_nearest_hosp_mi) |> \n  slice(1:10)\n\nkable(priority_counties,\n      col.names = c(\"County\", \"Vulnerable Residents\", \"Vulnerable Tracts\", \n                    \"Underserved Tracts\", \"Avg Distance to Nearest Hospital\"),\n      caption = \"Top 10 Priority Counties in PA for Healthcare Investment\",\n      format.args = list(big.mark = \",\"))\n```\n\n**Requirements:**\n\n-   Use `knitr::kable()` or similar for formatting\n\n-   Include descriptive column names\n\n-   Format numbers appropriately (commas for population, percentages, etc.)\n\n-   Add an informative caption\n\n-   Sort by priority (you decide the metric)\n\n--------------------------------------------------------------------------------\n\n## Part 2: Comprehensive Visualization\n\nUsing the skills from Week 3 (Data Visualization), create publication-quality\nmaps and charts.\n\n### Map 1: County-Level Choropleth\n\nCreate a choropleth map showing healthcare access challenges at the county\nlevel.\n\n**Your Task:**\n\n```{r}\nlibrary(scales)\nlibrary(RColorBrewer)\n\n# Spatial Joins and Projections\ncounty_summary_sf <- pa_counties_norm %>%\n  left_join(county_summary, by = \"county_geoid\")\nhosp_pts <- hospitals %>% st_transform(st_crs(county_summary_sf))\n\n# Create county-level access map\nggplot(county_summary_sf) +\n  geom_sf(aes(fill = pct_vuln_underserved), color = \"white\", linewidth = 0.25) +\n  geom_sf(data = hosp_pts, size = 0.9, alpha = 0.8) +\n  scale_fill_distiller(\n    name = \"% of vulnerable tracts\\n> 15 miles from a hospital\",\n    palette = \"Reds\",       \n    direction = 1,          # light (low) -> dark (high)\n    na.value = \"grey90\",\n    limits = c(0, 100),\n    breaks = c(0, 25, 50, 75, 100),\n    labels = label_percent(accuracy = 1, scale = 1),\n    guide = guide_colorbar(barheight = unit(80, \"pt\"))\n  ) +\n  labs(\n    title = \"Healthcare Access Challenges by County — Pennsylvania\",\n    subtitle = \"Percentage of vulnerable tracts that are underserved (threshold = 15 miles)\",\n    caption  = \"Notes: Grey counties have no vulnerable tracts. Distances computed in PA South State Plane\"\n  ) +\n  theme_void() +\n  theme(legend.position = \"right\")\n```\n\n**Requirements:** - Fill counties by percentage of vulnerable tracts that are\nunderserved - Include hospital locations as points - Use an appropriate color\nscheme - Include clear title, subtitle, and caption - Use `theme_void()` or\nsimilar clean theme - Add a legend with formatted labels\n\n--------------------------------------------------------------------------------\n\n### Map 2: Detailed Vulnerability Map\n\nCreate a map highlighting underserved vulnerable tracts.\n\n**Your Task:**\n\n```{r}\n# Create detailed tract-level map\nunderserved_threshold_mi <- 15\nvul_status <- vul_proj |> \n  mutate(\n    status = if_else(dist_nearest_hosp_mi > underserved_threshold_mi,\n                     \"Underserved\", \"Vulnerable\")\n  )\n\n# 2) Plot\nggplot() +\n  # Base: county boundaries for context (low visual weight)\n  geom_sf(data = pa_counties_norm, fill = NA, color = \"grey60\", linewidth = 0.3) +\n\n  # Other vulnerable tracts (de-emphasized)\n  geom_sf(data = subset(vul_status, status == \"Vulnerable\"),\n          aes(fill = status), color = NA, alpha = 0.35) +\n\n  # Underserved vulnerable tracts (primary focus)\n  geom_sf(data = subset(vul_status, status == \"Underserved\"),\n          aes(fill = status), color = \"#7f0000\", linewidth = 0.2, alpha = 0.9) +\n\n  # Hospitals (symbols on top for maximum legibility)\n  geom_sf(data = hosp_pts, aes(shape = \"Hospital\"),\n          size = 1.2, color = \"black\", fill = \"white\", stroke = 0.4) +\n\n  # Manual scales to control contrast & legend\n  scale_fill_manual(\n    name   = NULL,\n    values = c(\"Underserved\" = \"#cb181d\",  # strong red\n               \"Vulnerable\"  = \"grey80\")\n  ) +\n  scale_shape_manual(\n    name   = NULL,\n    values = c(\"Hospital\" = 21)  # filled circle w/ border\n  ) +\n  guides(\n    fill  = guide_legend(order = 1, override.aes = list(alpha = c(0.9, 0.35))),\n    shape = guide_legend(order = 2, override.aes = list(size = 3))\n  ) +\n\n  labs(\n    title    = \"Underserved Census Tracts and Hospital Locations — Pennsylvania\",\n    subtitle = \"Red tracts: vulnerable and > 15 miles from the nearest hospital\",\n    caption  = \"Distances computed in EPSG:32129 (PA South State Plane)\"\n  ) +\n  theme_void(base_size = 12) +\n  theme(\n    legend.position = \"right\",\n  ) +\n  coord_sf(datum = NA)\n```\n\n**Requirements:** - Show underserved vulnerable tracts in a contrasting color -\nInclude county boundaries for context - Show hospital locations - Use\nappropriate visual hierarchy (what should stand out?) - Include informative\ntitle and subtitle\n\n--------------------------------------------------------------------------------\n\n### Chart: Distribution Analysis\n\nCreate a visualization showing the distribution of distances to hospitals for\nvulnerable populations.\n\n**Your Task:**\n\n```{r}\n# Create distribution visualization\n\nvul_regions <- vul_proj |> \n  mutate(underserved = dist_nearest_hosp_mi > underserved_threshold_mi)\n\n# Compute tract centroids in lon/lat just for region assignment\nvul_ll <- st_transform(vul_regions, 4326)\nctr    <- st_centroid(vul_ll)\nlon    <- st_coordinates(ctr)[,1]\nq      <- quantile(lon, probs = c(1/3, 2/3), na.rm = TRUE)\n\nvul_regions <- vul_regions |> \n  mutate(region3 = case_when(\n    lon <= q[1] ~ \"West\",\n    lon >  q[2] ~ \"East\",\n    TRUE        ~ \"Central\"\n  )) %>%\n  mutate(region3 = factor(region3, levels = c(\"West\",\"Central\",\"East\")))\n\n# 1) Histogram of distances (with underserved threshold)\np_hist <- ggplot(vul_regions, aes(x = dist_nearest_hosp_mi)) +\n  geom_histogram(binwidth = 2, boundary = 0, closed = \"left\",\n                 fill = \"#9ecae1\", color = \"white\") +\n  geom_vline(xintercept = underserved_threshold_mi, linetype = \"dashed\") +\n  labs(\n    title   = \"Distribution of Distances to the Nearest Hospital (Vulnerable Tracts)\",\n    x       = \"Distance to nearest hospital (miles)\",\n    y       = \"Number of tracts\",\n    caption = \"Dashed line marks the underserved threshold (15 miles). Look for right-skew and the share beyond the threshold.\"\n  ) +\n  theme_minimal(base_size = 12)\n\n# 2) Box plot by regions (West/Central/East)\np_box <- ggplot(vul_regions, aes(x = region3, y = dist_nearest_hosp_mi, fill = region3)) +\n  geom_boxplot(outlier.alpha = 0.3) +\n  geom_hline(yintercept = underserved_threshold_mi, linetype = \"dashed\") +\n  scale_fill_brewer(palette = \"Set2\", guide = \"none\") +\n  labs(\n    title    = \"Distance to Hospital by Region (Vulnerable Tracts)\",\n    subtitle = \"Regions defined by longitude terciles (West, Central, East)\",\n    x        = NULL,\n    y        = \"Distance to nearest hospital (miles)\",\n    caption  = \"Regions with higher medians indicate broader access challenges.\"\n  ) +\n  theme_minimal(base_size = 12)\n\n# 3) Bar chart: underserved tracts by county (Top 15 for readability)\nbar_df <- county_summary %>%\n  select(county_name, n_underserved_tracts) %>%\n  arrange(desc(n_underserved_tracts)) %>%\n  slice_head(n = 15)\n\np_bar <- ggplot(bar_df,\n                aes(x = reorder(county_name, n_underserved_tracts),\n                    y = n_underserved_tracts)) +\n  geom_col(fill = \"#cb181d\") +\n  coord_flip() +\n  labs(\n    title   = \"Underserved Vulnerable Tracts by County (Top 15)\",\n    x       = NULL,\n    y       = \"Underserved vulnerable tracts (count)\",\n    caption = \"Highlights where the count of tracts beyond 15 miles is most concentrated.\"\n  ) +\n  theme_minimal(base_size = 12)\n\n# 4) Scatter: distance vs. vulnerable population size (per tract)\np_scatter <- ggplot(vul_regions,\n                    aes(x = dist_nearest_hosp_mi,\n                        y = total_popE,\n                        color = underserved)) +\n  geom_point(alpha = 0.5) +\n  geom_smooth(method = \"loess\", se = FALSE,\n              linetype = \"dashed\", color = \"black\", linewidth = 0.8) +\n  scale_color_manual(\n    values = c(`TRUE` = \"#cb181d\", `FALSE` = \"grey60\"),\n    name   = \"Underserved?\",\n    labels = c(\"No (≤ 15 mi)\", \"Yes (> 15 mi)\")\n  ) +\n  scale_y_continuous(labels = comma) +\n  labs(\n    title   = \"Distance vs. Vulnerable Population Size (Tracts)\",\n    x       = \"Distance to nearest hospital (miles)\",\n    y       = \"Vulnerable population (tract total)\",\n    caption = \"Dashed curve shows the local trend\"\n  ) +\n  theme_minimal(base_size = 12)\n\n\n```\n\n```{r}\np_hist\np_box\np_bar\np_scatter\n```\n\n**Suggested chart types:** - Histogram or density plot of distances - Box plot\ncomparing distances across regions - Bar chart of underserved tracts by county -\nScatter plot of distance vs. vulnerable population size\n\n**Requirements:** - Clear axes labels with units - Appropriate title -\nProfessional formatting - Brief interpretation (1-2 sentences as a caption or in\ntext)\n\n--------------------------------------------------------------------------------\n\n## Part 3: Bring Your Own Data Analysis\n\nChoose your own additional spatial dataset and conduct a supplementary analysis.\n\n### Challenge Options\n\nChoose ONE of the following challenge exercises, or propose your own research\nquestion using OpenDataPhilly data (https://opendataphilly.org/datasets/).\n\n**Note these are just loose suggestions to spark ideas - follow or make your own\nas the data permits and as your ideas evolve. This analysis should include\nbringing in your own dataset, ensuring the projection/CRS of your layers align\nand are appropriate for the analysis (not lat/long or geodetic coordinate\nsystems). The analysis portion should include some combination of spatial and\nattribute operations to answer a relatively straightforward question**\n\n--------------------------------------------------------------------------------\n\n#### Education & Youth Services\n\n**Option A: Educational Desert Analysis**\n\n-   **Data:** Schools, Libraries, Recreation Centers, Census tracts (child\n    population)\n\n-   **Question:** \"Which neighborhoods lack adequate educational infrastructure\n    for children?\"\n\n-   **Operations:** Buffer schools/libraries (0.5 mile walking distance),\n    identify coverage gaps, overlay with child population density\n\n-   **Policy relevance:** School district planning, library placement,\n    after-school program siting\n\n**Option B: School Safety Zones**\n\n-   **Data:** Schools, Crime Incidents, Bike Network\n\n-   **Question:** \"Are school zones safe for walking/biking, or are they crime\n    hotspots?\"\n\n-   **Operations:** Buffer schools (1000ft safety zone), spatial join with crime\n    incidents, assess bike infrastructure coverage\n\n-   **Policy relevance:** Safe Routes to School programs, crossing guard\n    placement\n\n--------------------------------------------------------------------------------\n\n#### Environmental Justice\n\n**Option C: Green Space Equity**\n\n-   **Data:** Parks, Street Trees, Census tracts (race/income demographics)\n-   **Question:** \"Do low-income and minority neighborhoods have equitable\n    access to green space?\"\n-   **Operations:** Buffer parks (10-minute walk = 0.5 mile), calculate tree\n    canopy or park acreage per capita, compare by demographics\n-   **Policy relevance:** Climate resilience, environmental justice, urban\n    forestry investment - ---\n\n#### Public Safety & Justice\n\n**Option D: Crime & Community Resources**\n\n-   **Data:** Crime Incidents, Recreation Centers, Libraries, Street Lights\n\n-   **Question:** \"Are high-crime areas underserved by community resources?\"\n\n-   **Operations:** Aggregate crime counts to census tracts or neighborhoods,\n    count community resources per area, spatial correlation analysis\n\n-   **Policy relevance:** Community investment, violence prevention strategies\n\n#### Infrastructure & Services\n\n**Option E: Polling Place Accessibility**\n\n-   **Data:** Polling Places, SEPTA stops, Census tracts (elderly population,\n    disability rates)\n\n-   **Question:** \"Are polling places accessible for elderly and disabled\n    voters?\"\n\n-   **Operations:** Buffer polling places and transit stops, identify vulnerable\n    populations, find areas lacking access\n\n-   **Policy relevance:** Voting rights, election infrastructure, ADA compliance\n\n--------------------------------------------------------------------------------\n\n#### Health & Wellness\n\n**Option F: Recreation & Population Health**\n\n-   **Data:** Recreation Centers, Playgrounds, Parks, Census tracts\n    (demographics)\n\n-   **Question:** \"Is lack of recreation access associated with vulnerable\n    populations?\"\n\n-   **Operations:** Calculate recreation facilities per capita by neighborhood,\n    buffer facilities for walking access, overlay with demographic indicators\n\n-   **Policy relevance:** Public health investment, recreation programming,\n    obesity prevention\n\n--------------------------------------------------------------------------------\n\n#### Emergency Services\n\n**Option G: EMS Response Coverage**\n\n-   **Data:** Fire Stations, EMS stations, Population density, High-rise\n    buildings\n\n-   **Question:** \"Are population-dense areas adequately covered by emergency\n    services?\"\n\n-   **Operations:** Create service area buffers (5-minute drive = \\~2 miles),\n    assess population coverage, identify gaps in high-density areas\n\n-   **Policy relevance:** Emergency preparedness, station siting decisions\n\n--------------------------------------------------------------------------------\n\n#### Arts & Culture\n\n**Option H: Cultural Asset Distribution**\n\n-   **Data:** Public Art, Museums, Historic sites/markers, Neighborhoods\n\n-   **Question:** \"Do all neighborhoods have equitable access to cultural\n    amenities?\"\n\n-   **Operations:** Count cultural assets per neighborhood, normalize by\n    population, compare distribution across demographic groups\n\n-   **Policy relevance:** Cultural equity, tourism, quality of life,\n    neighborhood identity\n\n--------------------------------------------------------------------------------\n\n### Data Sources\n\n**OpenDataPhilly:** https://opendataphilly.org/datasets/ - Most datasets\navailable as GeoJSON, Shapefile, or CSV with coordinates - Always check the\nMetadata for a data dictionary of the fields.\n\n**Additional Sources:**\n\n-   **Pennsylvania Open Data:** https://data.pa.gov/\n\n-   **Census Bureau (via tidycensus):** Demographics, economic indicators,\n    commute patterns\n\n-   **TIGER/Line (via tigris):** Geographic boundaries\n\n### Recommended Starting Points\n\n**If you're feeling confident:** Choose an advanced challenge with multiple data\nlayers. **If you are a beginner, choose something more manageable that helps you\nunderstand the basics**\n\n**If you have a different idea:** Propose your own question! Just make sure:\n\n-   You can access the spatial data\n\n-   You can perform at least 2 spatial operations\n\n### Your Analysis\n\n**My Chosen Question: Small Businesses**\n\n-   **Question:** \"Is lack of recreation access associated with vulnerable\n    populations?\"\n\n<!-- -->\n\n-   Data Source A:\n    <https://phl.maps.arcgis.com/apps/MapSeries/index.html?appid=ab8597d96ece43be97e718f919e79194>\n\n-   Data Source B:\n    <https://opendataphilly.org/datasets/neighborhood-food-retail/>\n\n-   Data Source C: Dataaxle\n\n**Your Task:**\n\n1.  **Find and load additional data**\n    -   Document your data source\n    -   Check and standardize the CRS\n    -   Provide basic summary statistics\n\n```{r}\n# Load your additional dataset\n\n\n\n\n```\n\n**Questions to answer:**\n\n-   What dataset did you choose and why?\n\n-   What is the data source and date?\n\n-   How many features does it contain?\n\n-   What CRS is it in? Did you need to transform it?\n\n--------------------------------------------------------------------------------\n\n2.  **Pose a research question**\n\nWrite a clear research statement that your analysis will answer.\n\n**Examples:** - \"Do vulnerable tracts have adequate public transit access to\nhospitals?\" - \"Are EMS stations appropriately located near vulnerable\npopulations?\" - \"Do areas with low vehicle access have worse hospital access?\"\n\n--------------------------------------------------------------------------------\n\n3.  **Conduct spatial analysis**\n\nUse at least TWO spatial operations to answer your research question.\n\n**Required operations (choose 2+):**\n\n-   Buffers / Intersections / Unions / Distance Calculations\n\n-   Spatial joins\n\n-   Spatial filtering with predicates\n\n-   Point-in-polygon aggregation\n\n**Your Task:**\n\n```{r}\n# Your spatial analysis\n\n\n\n\n\n\n\n\n\n\n```\n\n**Analysis requirements:**\n\n-   Clear code comments explaining each step\n\n-   Appropriate CRS transformations\n\n-   Summary statistics or counts\n\n-   At least one map showing your findings\n\n-   Brief interpretation of results (3-5 sentences)\n\n**Your interpretation:**\n\n*\\[Write your findings here\\]*\n\n## Finally - A few comments about your incorporation of feedback!\n\nTake a few moments to clean up your markdown document and then write a line or\ntwo or three about how you may have incorporated feedback that you recieved\nafter your first assignment.\n\n*\\[Incorporation of Feedback\\]*\n\n--------------------------------------------------------------------------------\n\n## Submission Requirements\n\n**What to submit:**\n\n1.  **Rendered HTML document posted to your course portfolio** with all code,\n    outputs, maps, and text\n    -   Use `embed-resources: true` in YAML so it's a single file\n    -   All code should run without errors\n    -   All maps and charts should display correctly\n\n**File naming:** `LastName_FirstName_Assignment2.html` and\n`LastName_FirstName_Assignment2.qmd`\n\n--------------------------------------------------------------------------------\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":"auto","echo":true,"output":true,"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"message":false,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":false,"code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","toc":true,"embed-resources":true,"output-file":"assignment2_template.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.8.23","theme":"cosmo","title":"Assignment 2: Spatial Analysis and Visualization","subtitle":"Healthcare Access and Equity in Pennsylvania","author":"Jed Chew","date":"today","editor":{"markdown":{"wrap":80}},"toc-location":"left"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}